
## General Behavior

Before starting any implementation or codebase exploration, ask the user what they want to focus on first. Do not autonomously explore or begin work without confirming the starting point.

## Flow Control

After receiving an AskUserQuestion answer, immediately execute the next action. Do not summarize, confirm, or pause. The answer is input to continue work, not a stopping point.

## Language & Stack

This project primarily uses TypeScript and Rust. When generating code, default to TypeScript for frontend/API work and Rust for backend/systems work unless otherwise specified.

## Git

Follow Conventional Commits for commit messages. Examples: `fix:`, `feat:`, `chore:`, `docs:`, `refactor:`, `test:`

## Development Workflow

Use compound-engineering workflows as the default process for non-trivial tasks:
- **brainstorm** → **plan** → **work** → **review** → **compound**
- Design and planning come first (80%). Implementation is the smaller part (20%).
- After solving a problem, document the solution immediately (`/workflows:compound`) so future work compounds on past learnings.
- Use `/workflows:plan` for any feature or change that touches 3+ files. Skip only for single-file trivial fixes.

## Planning & Organization

When the user asks for planning, organization, or 'next steps', deliver a structured written response (numbered list or table) BEFORE reading additional files. Prioritize answering with what you already know, then fill gaps.

## Shell Environment (NixOS)

Standard commands are aliased to modern replacements on this system:
- `find` → `fd`, `grep` → `rg`, `cat` → `bat`, `sed` → `sd`
- Use the replacement tools directly (e.g., `fd` not `find`). For `sed`-like operations, use the Edit tool instead of Bash.
- If a build/run command fails twice with the same error, stop and analyze the error output before retrying.

## Edit Tool Discipline

- Always Read the target file before editing to confirm current content.
- Include 3+ lines of unique surrounding context in `old_string` to ensure uniqueness.
- For Nix files: include the full attribute path context (e.g., the enclosing block header).
- For TSX/TS files: include the function or component name line as anchor context.
- If an Edit fails, re-Read the file before retrying.
- Plan multi-part changes as a single comprehensive edit when possible.

## Retry Limits

- If a tool call fails 3 times in a row on the same file or operation, STOP:
  1. Re-read the file to get fresh state
  2. Explain the failure to the user
  3. Try a fundamentally different approach
- Never retry the same Bash command more than 2 times without changing the approach.

# Goal Design & Intent Modeling

## ゴールを受け取ったとき

ゴールを受け取ったら、実装前に以下の5項目が揃っているか確認せよ。
揃っていない項目があれば、実装を始める前に選択肢を提示して埋めよ。

```
目的:         なぜこれを解くのか・なぜ今なのか
解かないこと: 今回スコープ外にするもの
制約:         技術・時間・既存システムとの整合性
最低限:       目的達成に不可欠な要素のみ
検証基準:     WHEN [条件] THEN [期待動作] の形式で書けること
```

**検証基準が書けない = 探索フェーズ未完了。** 実装せず、まず選択肢を出せ。

## HitLを挟む判断基準

以下のときだけ確認を求めよ。それ以外は自律実行せよ。

- インターフェース・スキーマ・API境界を新設・変更するとき（コントラクト確定）
- 後述の「未確定ドメイン（U）」に触れる実装をするとき
- 明示されたゴールと選好ログ（L）が矛盾しているとき

## 選好ログ（L）と未確定ドメイン（U）

このファイルまたはプロジェクトの `CLAUDE.md` に以下のセクションがあれば従え。

```
## 選好ログ（L）
- [ドメイン]: [確定した選好]

## 未確定ドメイン（U）
- [まだ選好が定まっていない領域]
```

**Uに触れたとき:** 実装前に必ずプローブを投げよ。

## プローブのルール

プローブは直感を引き出す形式にせよ。分析を強制するな。

```
✓ 「AとBどちらが好みですか？（理由不要）」
✓ 「このネーミング、違和感ありますか？(y/n)」
✗ 「この実装についてどう思いますか？」
✗ 「AとBのどちらが要件を満たしていますか？」
```

一度に聞くプローブは1つ。理由は求めるな。

## セッション終了プロトコル（MUST）

タスク完了後、必ず以下を実行せよ。実行しないと次のセッションがゼロから始まる。

1. このセッションで選好に関わる判断をした箇所を特定する
2. `選好ログ（L）` の該当ドメインを更新する
3. `未確定ドメイン（U）` から解決済みの項目を削除する
