# Wallpaper Theme Sync Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Select wallpaper from GUI picker and automatically sync colors across all apps (ghostty, waybar, mako, fuzzel, swaylock, niri).

**Architecture:** waypaper (GUI picker) → swww (wallpaper) → wallust (color extraction) → templates → reload apps

**Tech Stack:** waypaper, wallust, swww, bash scripts

---

## Task 1: Add Packages

**Files:**
- Modify: `home/default.nix:65-68` (Nix tools section)

**Step 1: Add waypaper and wallust to packages**

In `home/default.nix`, add to the packages list after the Nix tools section:

```nix
      # Nix tools
      nixfmt
      statix
      deadnix

      # Wallpaper theming
      waypaper
      wallust
```

**Step 2: Commit**

```bash
git add home/default.nix
git commit -m "feat: add waypaper and wallust for wallpaper theming"
```

---

## Task 2: Create wallust Config

**Files:**
- Create: `config/wallust/wallust.toml`

**Step 1: Create wallust config directory**

```bash
mkdir -p config/wallust
```

**Step 2: Create wallust.toml**

```toml
# Wallust configuration
# https://codeberg.org/explosion-mental/wallust/wiki

[wallust]
# Color backend
backend = "resized"
# Color space for interpolation
color_space = "lab"
# Palette type
palette = "dark16"

# Threshold for when to use a different color
threshold = 20

# Check if wallpaper already has cached colors
check_contrast = true

# Alpha value for terminal colors (0-100)
alpha = 100

[templates]
ghostty = { template = "ghostty.conf", target = "~/.config/ghostty/colors" }
mako = { template = "mako.conf", target = "~/.config/mako/config" }
fuzzel = { template = "fuzzel.ini", target = "~/.config/fuzzel/fuzzel.ini" }
waybar = { template = "waybar.css", target = "~/.config/waybar/colors.css" }
swaylock = { template = "swaylock.conf", target = "~/.config/swaylock/config" }
niri = { template = "niri-colors.txt", target = "~/.cache/wallust/niri-colors.txt" }
```

**Step 3: Commit**

```bash
git add config/wallust/wallust.toml
git commit -m "feat: add wallust configuration"
```

---

## Task 3: Create Ghostty Template

**Files:**
- Create: `config/wallust/templates/ghostty.conf`

**Step 1: Create templates directory**

```bash
mkdir -p config/wallust/templates
```

**Step 2: Create ghostty template**

```
# Ghostty colors generated by wallust
# Source wallpaper: {{wallpaper}}

background = {{background}}
foreground = {{foreground}}
cursor-color = {{cursor}}

palette = 0={{color0}}
palette = 1={{color1}}
palette = 2={{color2}}
palette = 3={{color3}}
palette = 4={{color4}}
palette = 5={{color5}}
palette = 6={{color6}}
palette = 7={{color7}}
palette = 8={{color8}}
palette = 9={{color9}}
palette = 10={{color10}}
palette = 11={{color11}}
palette = 12={{color12}}
palette = 13={{color13}}
palette = 14={{color14}}
palette = 15={{color15}}
```

**Step 3: Commit**

```bash
git add config/wallust/templates/ghostty.conf
git commit -m "feat: add wallust template for ghostty"
```

---

## Task 4: Create Mako Template

**Files:**
- Create: `config/wallust/templates/mako.conf`

**Step 1: Create mako template**

```
# Mako Notification Daemon - wallust generated
# Source: {{wallpaper}}

# General
font=HackGen Console NF 12
width=380
height=120
margin=12
padding=16
border-size=2
border-radius=8
icons=1
icon-path=/usr/share/icons/Papirus-Dark
max-icon-size=48
default-timeout=5000
ignore-timeout=0
max-visible=5
layer=overlay
anchor=top-right

# Colors
background-color={{background}}cc
text-color={{foreground}}
border-color={{color8}}
progress-color=over {{color4}}

# Urgency levels
[urgency=low]
border-color={{color8}}
default-timeout=3000

[urgency=normal]
border-color={{color4}}

[urgency=critical]
border-color={{color1}}
text-color={{color9}}
default-timeout=0

# App-specific styling
[app-name=Spotify]
border-color={{color2}}

[app-name=discord]
border-color={{color5}}

[app-name=Firefox]
border-color={{color3}}
```

**Step 2: Commit**

```bash
git add config/wallust/templates/mako.conf
git commit -m "feat: add wallust template for mako"
```

---

## Task 5: Create Fuzzel Template

**Files:**
- Create: `config/wallust/templates/fuzzel.ini`

**Step 1: Create fuzzel template**

```ini
[main]
font=HackGen Console NF:size=14
dpi-aware=no
width=40
horizontal-pad=16
vertical-pad=12
inner-pad=8

[colors]
# wallust generated from {{wallpaper}}
background={{background | replace(from="#", to="")}}cc
text={{foreground | replace(from="#", to="")}}ff
match={{color4 | replace(from="#", to="")}}ff
selection={{color8 | replace(from="#", to="")}}ff
selection-text={{foreground | replace(from="#", to="")}}ff
selection-match={{color12 | replace(from="#", to="")}}ff
border={{color8 | replace(from="#", to="")}}ff

[border]
width=2
radius=8
```

**Step 2: Commit**

```bash
git add config/wallust/templates/fuzzel.ini
git commit -m "feat: add wallust template for fuzzel"
```

---

## Task 6: Create Waybar Colors Template

**Files:**
- Create: `config/wallust/templates/waybar.css`

**Step 1: Create waybar colors template**

This generates a colors.css that will be imported by the main style.css.

```css
/* Waybar colors generated by wallust */
/* Source: {{wallpaper}} */

@define-color background {{background}};
@define-color foreground {{foreground}};
@define-color cursor {{cursor}};

@define-color color0 {{color0}};
@define-color color1 {{color1}};
@define-color color2 {{color2}};
@define-color color3 {{color3}};
@define-color color4 {{color4}};
@define-color color5 {{color5}};
@define-color color6 {{color6}};
@define-color color7 {{color7}};
@define-color color8 {{color8}};
@define-color color9 {{color9}};
@define-color color10 {{color10}};
@define-color color11 {{color11}};
@define-color color12 {{color12}};
@define-color color13 {{color13}};
@define-color color14 {{color14}};
@define-color color15 {{color15}};
```

**Step 2: Commit**

```bash
git add config/wallust/templates/waybar.css
git commit -m "feat: add wallust template for waybar colors"
```

---

## Task 7: Create Swaylock Template

**Files:**
- Create: `config/wallust/templates/swaylock.conf`

**Step 1: Create swaylock template**

```
# Swaylock - wallust generated
# Source: {{wallpaper}}

# Behavior
ignore-empty-password
show-failed-attempts

# Appearance
color={{background | replace(from="#", to="")}}
font=HackGen Console NF
font-size=24

# Indicator
indicator-radius=120
indicator-thickness=12
indicator-caps-lock

# Colors
inside-color={{background | replace(from="#", to="")}}
inside-clear-color={{background | replace(from="#", to="")}}
inside-caps-lock-color={{background | replace(from="#", to="")}}
inside-ver-color={{background | replace(from="#", to="")}}
inside-wrong-color={{background | replace(from="#", to="")}}

ring-color={{color8 | replace(from="#", to="")}}
ring-clear-color={{color2 | replace(from="#", to="")}}
ring-caps-lock-color={{color3 | replace(from="#", to="")}}
ring-ver-color={{color4 | replace(from="#", to="")}}
ring-wrong-color={{color1 | replace(from="#", to="")}}

line-color=00000000
line-clear-color=00000000
line-caps-lock-color=00000000
line-ver-color=00000000
line-wrong-color=00000000

separator-color=00000000

key-hl-color={{color5 | replace(from="#", to="")}}
bs-hl-color={{color1 | replace(from="#", to="")}}
caps-lock-key-hl-color={{color3 | replace(from="#", to="")}}
caps-lock-bs-hl-color={{color1 | replace(from="#", to="")}}

text-color={{foreground | replace(from="#", to="")}}
text-clear-color={{color2 | replace(from="#", to="")}}
text-caps-lock-color={{color3 | replace(from="#", to="")}}
text-ver-color={{color4 | replace(from="#", to="")}}
text-wrong-color={{color1 | replace(from="#", to="")}}

# Layout
layout-bg-color=00000000
layout-border-color=00000000
layout-text-color={{foreground | replace(from="#", to="")}}
```

**Step 2: Commit**

```bash
git add config/wallust/templates/swaylock.conf
git commit -m "feat: add wallust template for swaylock"
```

---

## Task 8: Create Niri Colors Template

**Files:**
- Create: `config/wallust/templates/niri-colors.txt`

**Step 1: Create niri colors template**

This outputs color values that can be used by a script to update niri config.

```
# Niri colors generated by wallust
# Source: {{wallpaper}}
NIRI_ACTIVE_FROM={{color5}}
NIRI_ACTIVE_TO={{color4}}
NIRI_INACTIVE={{color8}}
```

**Step 2: Commit**

```bash
git add config/wallust/templates/niri-colors.txt
git commit -m "feat: add wallust template for niri colors"
```

---

## Task 9: Create Theme Reload Script

**Files:**
- Create: `config/wallust/scripts/reload-theme.sh`

**Step 1: Create scripts directory**

```bash
mkdir -p config/wallust/scripts
```

**Step 2: Create reload script**

```bash
#!/usr/bin/env bash
set -euo pipefail

# Reload theme after wallust generates new colors
# Called by waypaper's post_command

# Reload mako notifications
pkill -USR2 mako || true

# Reload waybar
pkill -SIGUSR2 waybar || true

# Notify user
notify-send "Theme Updated" "Colors synced from wallpaper" -t 2000
```

**Step 3: Make executable**

```bash
chmod +x config/wallust/scripts/reload-theme.sh
```

**Step 4: Commit**

```bash
git add config/wallust/scripts/reload-theme.sh
git commit -m "feat: add theme reload script"
```

---

## Task 10: Create Waypaper Config

**Files:**
- Create: `config/waypaper/config.ini`

**Step 1: Create waypaper config directory**

```bash
mkdir -p config/waypaper
```

**Step 2: Create waypaper config**

```ini
[Settings]
language = en
folder = ~/Pictures/Wallpapers
wallpaper = ~/.config/wallpaper/skyrim.jpg
backend = swww
monitors = All
fill = fill
sort = name
color = #1f1f28
subfolders = False
show_hidden = False
show_gifs_only = False
post_command = wallust run $wallpaper && ~/.config/wallust/scripts/reload-theme.sh
number_of_columns = 3
swww_transition_type = grow
swww_transition_step = 90
swww_transition_angle = 0
swww_transition_duration = 2
swww_transition_fps = 60
```

**Step 3: Commit**

```bash
git add config/waypaper/config.ini
git commit -m "feat: add waypaper configuration with wallust integration"
```

---

## Task 11: Update Waybar Style to Import Colors

**Files:**
- Modify: `config/waybar/style.css:1-23`

**Step 1: Replace hardcoded colors with import**

Change the beginning of `config/waybar/style.css` from hardcoded Kanagawa colors to:

```css
/* Import wallust-generated colors */
@import "colors.css";

/* Fallback colors if colors.css doesn't exist */
@define-color background #1f1f28;
@define-color foreground #dcd7ba;

* {
    font-family: "HackGen Console NF";
    font-size: 12px;
    min-height: 0;
    padding: 0;
    margin: 0;
}

window#waybar {
    background: transparent;
    color: @foreground;
}
```

**Step 2: Update module colors to use CSS variables**

Update the module styling to use the new color variables (e.g., replace `@fujiWhite` with `@foreground`, `@sumiInk1` with `@background`).

**Step 3: Commit**

```bash
git add config/waybar/style.css
git commit -m "refactor: use wallust-generated colors in waybar"
```

---

## Task 12: Update Ghostty Config to Import Colors

**Files:**
- Modify: `config/ghostty/config:12-13`

**Step 1: Replace theme with config-file import**

Change:
```
theme = Kanagawa Wave
```

To:
```
# Colors from wallust (fallback to Kanagawa Wave if not present)
config-file = ~/.config/ghostty/colors
```

**Step 2: Create initial colors file**

Create `config/ghostty/colors` with current Kanagawa colors as fallback:

```
# Initial colors (will be overwritten by wallust)
background = #1f1f28
foreground = #dcd7ba
cursor-color = #c8c093

palette = 0=#16161d
palette = 1=#c34043
palette = 2=#98bb6c
palette = 3=#ff9e3b
palette = 4=#7e9cd8
palette = 5=#957fb8
palette = 6=#7aa89f
palette = 7=#c8c093
palette = 8=#54546d
palette = 9=#ff5d62
palette = 10=#98bb6c
palette = 11=#e6c384
palette = 12=#7fb4ca
palette = 13=#d27e99
palette = 14=#7aa89f
palette = 15=#dcd7ba
```

**Step 3: Commit**

```bash
git add config/ghostty/config config/ghostty/colors
git commit -m "refactor: use wallust-generated colors in ghostty"
```

---

## Task 13: Add XDG Config Symlinks

**Files:**
- Modify: `home/default.nix` (xdg.configFile section)

**Step 1: Add wallust and waypaper symlinks**

Add to the `xdg.configFile` section in `home/default.nix`:

```nix
    "wallust".source = config.lib.file.mkOutOfStoreSymlink "${dotfilesPath}/config/wallust";
    "waypaper".source = config.lib.file.mkOutOfStoreSymlink "${dotfilesPath}/config/waypaper";
```

**Step 2: Commit**

```bash
git add home/default.nix
git commit -m "feat: add XDG symlinks for wallust and waypaper configs"
```

---

## Task 14: Update Niri Startup

**Files:**
- Modify: `config/niri/config.kdl:161-162`

**Step 1: Replace hardcoded wallpaper with waypaper restore**

Change:
```kdl
// Set wallpaper (run after swww-daemon starts)
spawn-sh-at-startup "sleep 0.5 && swww img ~/.config/wallpaper/skyrim.jpg --transition-type grow --transition-pos center"
```

To:
```kdl
// Restore wallpaper and theme (waypaper handles swww + wallust)
spawn-sh-at-startup "sleep 0.5 && waypaper --restore"
```

**Step 2: Commit**

```bash
git add config/niri/config.kdl
git commit -m "refactor: use waypaper --restore for wallpaper on startup"
```

---

## Task 15: Create Wallpapers Directory Setup

**Files:**
- Create: `config/wallpaper/README.md` (update)

**Step 1: Update README with new workflow**

```markdown
# Wallpaper

## Usage

```bash
# Open wallpaper picker GUI
waypaper

# Restore last wallpaper and theme
waypaper --restore

# Set random wallpaper
waypaper --random
```

## How It Works

1. `waypaper` opens GUI to select wallpaper
2. Selection triggers `swww img` to set wallpaper
3. `post_command` runs `wallust run $wallpaper`
4. wallust extracts colors and generates configs for:
   - ghostty (terminal colors)
   - waybar (status bar)
   - mako (notifications)
   - fuzzel (app launcher)
   - swaylock (lock screen)
5. Reload script refreshes running apps

## Wallpaper Location

Add wallpapers to `~/Pictures/Wallpapers/` (configured in waypaper).

## Manual Theme Generation

```bash
# Generate theme from specific image
wallust run /path/to/image.jpg

# Reload apps
~/.config/wallust/scripts/reload-theme.sh
```
```

**Step 2: Commit**

```bash
git add config/wallpaper/README.md
git commit -m "docs: update wallpaper README with waypaper workflow"
```

---

## Task 16: Test and Apply

**Step 1: Apply NixOS configuration**

```bash
sudo nixos-rebuild switch --flake .#ryobox
```

**Step 2: Open new terminal and verify packages**

```bash
which waypaper wallust
```

Expected: Both paths should be printed.

**Step 3: Run waypaper**

```bash
waypaper
```

Expected: GUI opens showing wallpapers.

**Step 4: Select a wallpaper and verify**

- Pick any wallpaper
- Verify wallpaper changes
- Verify notification "Theme Updated" appears
- Check `~/.config/ghostty/colors` was generated
- Check `~/.config/waybar/colors.css` was generated

**Step 5: Final commit**

```bash
git add -A
git commit -m "feat: complete wallpaper theme sync system"
```

---

## Summary

After implementation:

- `waypaper` - Opens GUI wallpaper picker
- Selecting wallpaper automatically:
  1. Sets wallpaper via swww
  2. Extracts colors via wallust
  3. Generates configs for all apps
  4. Reloads mako and waybar
- `waypaper --restore` on startup restores last wallpaper + theme
